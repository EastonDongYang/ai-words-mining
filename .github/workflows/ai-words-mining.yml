name: AI Words Mining

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点运行
  workflow_dispatch:     # 允许手动触发
  push:
    branches: [ master ]
    paths:
      - 'main.py'
      - 'src/**'
      - 'config.py'
      - 'requirements.txt'

jobs:
  mine-words:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create credentials file
      run: |
        echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
      if: ${{ secrets.GOOGLE_CREDENTIALS }}
    
    - name: Run AI Words Mining
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
        GOOGLE_SHEETS_RANGE: ${{ secrets.GOOGLE_SHEETS_RANGE }}
        NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        TARGET_URL: https://www.toolify.ai/new
        DEBUG_MODE: true
      run: |
        python main.py
      continue-on-error: true  # 即使失败也继续，确保可以上传artifacts
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()  # 总是上传，即使前面步骤失败
      with:
        name: ai-words-mining-results-${{ github.run_number }}
        path: |
          artifacts/
          ai_words_backup_*.json
          ai_words_summary_*.txt
          ai_words_export.csv
          processed_words.json
          email_backup_*.txt
        retention-days: 30
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: execution-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 7
    
    - name: Create Release (if successful)
      if: success()
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: results-${{ github.run_number }}
        release_name: AI Words Mining Results ${{ github.run_number }}
        body: |
          🎉 AI Words Mining Results - Run #${{ github.run_number }}
          
          📅 Execution Date: ${{ github.event.head_commit.timestamp }}
          🔗 Workflow: ${{ github.workflow }}
          📊 Status: ✅ Success
          
          📄 Check the artifacts for detailed results:
          - JSON backup files
          - Human-readable summaries
          - CSV exports
          
          🔧 Configuration:
          - Target URL: https://www.toolify.ai/new
          - OpenAI API: ✅ Configured
          - Google Sheets: Check repository secrets
        draft: false
        prerelease: false
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "AI Words Mining failed. Check the logs and artifacts for details."
        # 可以在这里添加其他通知逻辑 